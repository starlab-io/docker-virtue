# Elasticsearch/Kibana
  
This guide details our elasticsearch and kibana stack, where it sits within our deployment, how we secure it with Searchguard, and how to quickly set it up wtih docker-compose.  

## Our Deployment

Currently, our elasticsearch deployment sits as a docker-compose stack on our aggregator.galahad.com node.  This brings up elasticsearch and kibana, and connects them to each other.  

Note that this was just for testing/development; this will NOT scale.  A correct elasticsearch deployment, utilizing the docker tooling we already have, would involve a cluster of ECS instances.  See  https://medium.com/@devfire/deploying-the-elk-stack-on-amazon-ecs-dd97d671df06 for a discussion on how to do this.  Such a deployment can be grown to hit whatever scale is required.  

## Elasticsearch in our Stack 

Elasticsearch is a NoSQL document store and search engine, focusing on handling log data.  Kibana is a front-end dashboard and data analysis tool for the same.  We store all of our log data in elasticsearch.

Our elasticsearch deployment has AuthN and AuthZ components currently built in.  All logs are sent to elasticsearch over https, and user accounts and appropiate certificates are required to access it (this is detailed in the searchguard section below).

As mentioned above, we have not spent time on building our elasticsearch instance to scale; this would be a required step if moving this to a more production-ready system.  

## Securing Elasticsearch (Searchguard)

We used the open source project SearchGuard for securing our elasticsearch instance.  SearchGuard provides the features of the Security X-Pack, plus some others.  It is free and open source for the basic requirements we use, with enterprise options for integrating directly into SSO and non-SSO auth systems.  

We use it both to managed encrypted communciation with elasticsearch, as well as key and username/password backed authentication mechanisms.

### Certificates 

We rely on on certificates for encryption and authentication.  All certificates within a deployment should be signed by the same root cert.  To generate the certificates needed for a deployment, see https://github.com/floragunncom/search-guard-ssl/tree/master/example-pki-scripts.  These scripts, with slight modifications, fully support our deployments.  Specfically, you will need to add correct SAN's in the gen_node_cert.sh script.  Most of the names auto-generated by these scripts should match how we are using them within our stack, but just in case, node certificates refer to certs for individual elasticsearch nodes, and client certificates will go anywhere else.  

### User Roles

Searchguard supports user roles via a variety of means; we used an internal user database kept in the ES instance, rather than linking with LDAP (this is an enterprise option).  See docker-virtue/elastic/esearch/searchguard/config for our role configration files.  Documentation for same can be found https://docs.search-guard.com/latest/internal-users-database

We did not a lot with these roles (we basically just used one admin account for everything), but there is capability to create restricted, append-only roles for either category (syslog-ng, merlin, excalibur), virtue, valor, or user.  This would restrict logging endpoints using the given role to only adding to the indicies they should, and prevent modification of logs.  


### Integrating with enterprise 

Searchguard supports a number of enterprise hookins for authentication and authorization.  Specifically for this deployment, they support Kerberos, PKI, Active Directory, and LDAP for user and role management.  A real, product version of this deployment would want to use one or more of these.  

## Setup

Using docker/docker-compose should get everything up and running.  IP addresses will need to be adjusted, but otherwise this should work as is. 

See the docker-compose/Dockerfile for setup commands.  If you want to install it locally, install elasticsearch 5.6.3 and be sure to run the searchguard plugn install shown in the elastic dockerfile.

See elastic/config/elasticsearch.yml for an example config.  This will work with the included files/certs, but IP's will need to be changed.  

A collection of scripts for generating a collection of certs for Elastic, Kibana, and the syslog-ng instances can be found:
* https://github.com/floragunncom/search-guard-ssl

Documentation can be found:
* http://docs.search-guard.com/latest/configuring-tls

### Starting Elasticsearch 

If you're starting the elasticsearch for the first time, after it has gotten going run 

	docker-compose exec -T elasticsearch bin/init_sg.sh

To set up the searchguard user roles and other settings.  

### Kibana setup

Also run from docker, see the included docker-compose/dockerfiles.  If you want to run locally, be sure to use version 5.6.3 and to install the searchguard plugin, as shown in kibana/Dockerfile.

### Seachguard users

The default users for the elasticsearch/kibana setup are:

* admin (password: admin): No restrictions for this user, can do everything
* kibanaro (password: kibanaro): Kibana user which can read every index
* kibanaserver (password: kibanaserver): User for the Kibana server (all permissions for .kibana index)
